#/bin/bash
#{{ ansible_managed }}
#
# This script is the script from which the FreeIPA stack was installed.
# It is primarly not intended for back-reference, and either the script or the
# stack might have been changed since. Do not mess with this unless you are
# the SysAdmin AND know what you are doing.
#
# This script is autogenerated and not intended to be easily readable.
# If you want something readable, consider the FreeIPA docs or the Ansible role.
#
# For full reference, see "https://www.mankier.com/1/ipa-server-install#Options".
#
BOPTIONS=""
DOPTIONS=""
#
### Basic Options
#
BOPTIONS+=" -r {{ REALM_NAME }}"
BOPTIONS+=" -n {{ DOMAIN_NAME }}"
BOPTIONS+=" -p {{ DM_PASSWORD }}"
BOPTIONS+=" -a {{ ADMIN_PASSWORD }}"
{#
% if MAKEHOMEDIR %}OPTIONS+=" --mkhomedir"{% endif %}
#}
BOPTIONS+=" --hostname={{ HOST_NAME }}"
BOPTIONS+=" --ip-address={{ IP_ADDRESS }}"
DOPTIONS+=" --ip-address={{ IP_ADDRESS }}"
{% if NO_NTP %}OPTIONS+=" -N"{% endif %}

BOPTIONS+=" --idstart={{ IDSTART }}"
BOPTIONS+=" --idmax={{ IDMAX }}"
{% if NO_HBAC_ALLOW %}BOPTIONS+=" --no-hbac-allow"{% endif %}

{% if IGNORE_TOPOLOGY_DISCONNECT %}BOPTIONS+=" --ignore-topology-disconnect"{% endif %}

{% if IGNORE_LAST_OF_ROLE %}BOPTIONS+=" --ignore-last-of-role"{% endif %}

{% if NO_UI_REDIRECT %}BOPTIONS+=" --no-ui-redirect"{% endif %}

{% if SSH_TRUST_DNS %}BOPTIONS+=" --ssh-trust-dns"{% endif %}

{% if NO_SSH %}BOPTIONS+=" --no-ssh"{% endif %}

{% if NO_SSHD %}BOPTIONS+=" --no-sshd"{% endif %}

{% if UNATTENDED %}BOPTIONS+=" -U"{% endif %}

{% if DIRSRV_CONFIG_FILE is defined %}BOPTIONS+=" --dirsrv-config-file={{ DIRSRV_CONFIG_FILE }}"{% endif %}
#
### Certificate System Options
#
{% if EXTERNAL_CA %}BOPTIONS+=" --external-ca"{% endif %}

{% if EXTERNAL_CA %}BOPTIONS+=" --external-ca-type={{ EXTERNAL_CA_TYPE }}"{% endif %}

{% if EXTERNAL_CERT_FILE %}BOPTIONS+=" --external-cert-file={{ EXTERNAL_CERT_FILE }}"{% endif %}

{% if NO_PKINIT %}BOPTIONS+=" --no-pkinit"{% endif %}

{% if DIRSRV_CERT_FILE %}BOPTIONS+=" --dirsrv-cert-file={{ DIRSRV_CERT_FILE }}"{% endif %}

{% if HTTP_CERT_FILE %}BOPTIONS+=" --http-cert-file={{ HTTP_CERT_FILE }}"{% endif %}

{% if PKINIT_CERT_FILE %}BOPTIONS+=" --pkinit-cert-file={{ PKINIT_CERT_FILE }}"{% endif %}

{% if DIRSRV_PIN %}BOPTIONS+=" --dirsrv-pin={{ DIRSRV_PIN }}"{% endif %}

{% if HTTP_PIN %}BOPTIONS+=" --http-pin={{ HTTP_PIN }}"{% endif %}

{% if PKINIT_PIN %}BOPTIONS+=" --pkinit-pin={{ PKINIT_PIN }}"{% endif %}

{% if DIRSRV_CERT_NAME %}BOPTIONS+=" --dirsrv-cert-name={{ DIRSRV_CERT_NAME }}"{% endif %}

{% if HTTP_CERT_NAME %}BOPTIONS+=" --http-cert-name={{ HTTP_CERT_NAME }}"{% endif %}

{% if PKINIT_CERT_NAME %}BOPTIONS+=" --pkinit-cert-name={{ PKINIT_CERT_NAME }}"{% endif %}

{% if CA_CERT_FILE %}BOPTIONS+=" --ca-cert-file={{ CA_CERT_FILE }}"{% endif %}

{% if CA_SUBJECT %}BOPTIONS+=" --ca-subject={{ CA_SUBJECT }}"{% endif %}

{% if SUBJECT_BASE %}BOPTIONS+=" --subject={{ SUBJECT_BASE }}"{% endif %}

{% if CA_SIGNING_ALGORITHM %}BOPTIONS+=" --ca-signing-algorithm={{ CA_SIGNING_ALGORITHM }}"{% endif %}

#
### KRA Options
#

#{% if SETUP_KRA %}BOPTIONS+=" --setup-kra"{% endif %}

#
### DNS Options
#
{% if NO_FORWARDERS %}DOPTIONS+=" --no-forwarders"{% else %}

  {% if FORWARDER_IP_ADDRESS %}DOPTIONS+=" --forwarder={{ FORWARDER_IP_ADDRESS }}"{% endif %}

  {% if AUTO_FORWARDERS %}DOPTIONS+=" --auto-forwarders"{% endif %}

  {% if FORWARD_POLICY %}DOPTIONS+=" --forward-policy={{ FORWARD_POLICY }}"{% endif %}

{% endif %}

{% if NO_REVERSE %}DOPTIONS+=" --no-reverse"{% else %}

  {% if REVERSE_ZONE %}DOPTIONS+=" --reverse-zone=REVERSE_ZONE"{% endif %}

{% endif %}

{% if AUTO_REVERSE %}DOPTIONS+=" --auto-reverse"{% endif %}


{# NO_SERIAL_AUTOINCREMENT not yet implemented in this role#}

{% if ZONEMGR %}DOPTIONS+=" --zonemgr={{ ZONEMGR }}"{% endif %}
{#
{% if NO_HOST_DNS %}DOPTIONS+=" --no-host-dns"{% endif %}

{% if NO_DNS_SSHFP %}DOPTIONS+=" --no-dns-sshfp"{% endif %}

{% if NO_DNSSEC_VALIDATION %}DOPTIONS+=" --no-dnssec-validation"{% endif %}

{% if ALLOW_ZONE_OVERLAP %}DOPTIONS+=" --allow-zone-overlap"{% endif %}
#}
{% if SETUP_ADTRUST %}DOPTIONS+=" --setup-adtrust"{% endif %}

{% if NETBIOS_NAME is defined %}DOPTIONS+=" --netbios-name={{ NETBIOS_NAME }}"{% endif %}

{% if RID_BASE %}DOPTIONS+=" --rid-base={{ RID_BASE }}"{% endif %}

{% if SECONDARY_RID_BASE %}DOPTIONS+=" --secondary-rid-base={{ SECONDARY_RID_BASE }}"{% endif %}

{% if ENABLE_COMPAT %}DOPTIONS+=" --enable-compat"{% endif %}

[[ `id -u` -eq 0 ]] && ipa-server-install ${BOPTIONS} && ipa-dns-install ${DOPTIONS} || echo "not root, running with sudo"
[[ `id -u` -gt 0 ]] && sudo ipa-server-install ${BOPTIONS} && sudo ipa-dns-install ${DOPTIONS} 
